<!DOCTYPE html>

<html lang="de">
<head>
<!--Mobile--> 
<meta name="viewport" content="width=device-width, initial-scale=1.0"> 
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Timetracker</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>

/*Mobile*/
@media (max-width: 600px) {
  body {
    padding: 0 0.8em;
  }

  .section {
    padding: 1.2em 1em;
    margin: 1.5em auto;
  }

  #tabs, #overviewTabs {
    flex-wrap: wrap;
    justify-content: center;
  }

  #tabs button,
  #overviewTabs button {
    flex: 1 1 auto;
    text-align: center;
  }

  .entry-filters {
    flex-direction: column;
    gap: 1em;
  }

  .entry-filters-row {
  display: flex;
  flex-wrap: wrap;
  gap: 1em;
  align-items: flex-end;
  justify-content: flex-start;
  margin-bottom: 1.5em;
}

.entry-filters-row > div {
  display: flex;
  flex-direction: column;
  min-width: 160px;
  max-width: 260px;
  flex: 1;
}

.selected-option {
  padding: 0.5em 0.8em;
  font-size: 1em;
  min-height: 2.4em;
  border: 1px solid #ccc;
  border-radius: 6px;
  cursor: pointer;
  background: white;
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}



#entryDateInputContainer {
  min-height: 2.5em; /* oder etwas mehr bei Bedarf */
}


  table {
    font-size: 0.85em;
    overflow-x: auto;
    display: block;
  }

  .entry-actions {
    flex-direction: column;
    gap: 0.2em;
    align-items: flex-start;
  }
}
 
/* === Mobile Optimierung === */
@media (max-width: 600px) {
  input,
  select,
  textarea,
  button {
    max-width: 100%;
    font-size: 0.95em;
  }

  .entry-filters {
    flex-direction: column;
    gap: 1em;
  }

  .entry-filters > div {
    width: 100%;
  }

  #overviewTabs,
  #tabs {
    flex-wrap: wrap;
    justify-content: center;
  }

  #overviewTabs button,
  #tabs button {
    flex: 1 1 48%;
    font-size: 0.9em;
    padding: 0.5em;
    text-align: center;
  }

  #entriesList {
    overflow-x: auto;
  }

  #entriesList table {
    font-size: 0.8em;
    min-width: 100%;
    table-layout: fixed;
  }

  #entriesList th,
  #entriesList td {
    word-wrap: break-word;
    padding: 0.4em 0.5em;
  }

  .entry-actions {
    flex-direction: column;
    gap: 0.2em;
    align-items: flex-start;
  }

  .section {
    padding: 1em;
    margin: 1.2em auto;
  }

  .section h2 {
    font-size: 1.3em;
  }
} 



/*Ende Mobile*/

    body { font-family: sans-serif; margin: 0; padding: 0 1em; background: #f7f7f7; }
    h1, h2 { color: #333; }
    .section { display: none; padding: 1em 0; }
    .active { display: block; }
    label { display: block; margin-top: 1em; }
    input, select, textarea, button {
      font-size: 1em;
      padding: 0.4em;
      width: 100%;
      max-width: 300px;
      margin-top: 0.3em;
    }

    form {
  max-width: 320px;
  width: 100%;
}

form input,
form select,
form textarea,
form button {
  width: 100%;
  box-sizing: border-box;
  font: inherit;
}

.inline-group {
  display: flex;
  width: 100%;
  justify-content: space-between;
}

.field-third {
  width: 32.3%; 
  display: flex;
  flex-direction: column;
}

.inline-group input {
  padding-left: 0.5em;
  padding-right: 0.5em;
  font: inherit;
  box-sizing: border-box;
}


.inline-group > div {
  width: 32.3%; /* exakt 3 Felder mit Abstand */
  display: flex;
  flex-direction: column;
}




    form button {
    display: block;
    margin-top: 1em;
    }
    textarea { height: 100px; }
    table { width: 100%; border-collapse: collapse; margin-top: 1em; }
    th, td { border: 1px solid #ccc; padding: 0.5em; text-align: left; }
    #tabs {
  display: flex;
  justify-content: center;
  gap: 0.5em;
  padding: 1em;
  background: #eaeaea;
  border-radius: 12px;
  box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.05);
  max-width: 900px;
  margin: 2em auto 2em auto;
}

#tabs button {
  padding: 0.6em 1.2em;
  background: #ffffff;
  border: 1px solid #ccc;
  border-radius: 8px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
}

#tabs button:hover {
  background: #f0f0f0;
}

#tabs button.active-tab {
  background: #d0d0d0;
  border-color: #999;
  font-weight: bold;
}
    #stopwatchDisplay {
      font-size: 2em;
      margin-bottom: 10px;
    }

   /* √úbersicht-Filter-Buttons (Tag, Woche, Monat, Jahr) */
   #overviewTabs {
  display: flex;
  justify-content: center;
  gap: 0.5em;
  margin-bottom: 1em;
}

#overviewTabs button {
  padding: 0.3em 1em;
  font-size: 0.9em;
  background: #f0f0f0;
  border: 1px solid #d0d0d0;
  border-radius: 999px;
  cursor: pointer;
  transition: all 0.2s ease;
  color: #333;
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

#overviewTabs button:hover {
  background: #e0e0e0;
  box-shadow: 0 2px 4px rgba(0,0,0,0.08);
}

#overviewTabs button.active-overview {
  background: #dcdcdc;
  border-color: #aaa;
  font-weight: 600;
  color: #111;
  box-shadow: inset 0 0 0 1px #bbb;
}

#weekNav {
  font-size: 0.9em;
  color: #444;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 0.6em;
  flex-wrap: wrap;
}

#weekNav button {
  background: none;
  border: none;
  font-size: 1.2em;
  cursor: pointer;
  color: #666;
  padding: 0 0.2em;
  transition: color 0.2s;
}

#weekNav button:hover {
  color: #000;
}

#overviewChart {
  width: 400px;
  height: 400px;
  display: block;
  margin: 0 auto;
}

/* Tabelle enger & kompakter */
#entriesList {
  max-width: 1100px;
  margin: 2em auto;
  overflow-x: auto; /* sicherstellen, dass scrollbar erscheint, wenn n√∂tig */
}

#entriesList table {
  width: 100%;
  border-collapse: collapse;
  font-size: 1.05em;
  table-layout: fixed; /* WICHTIG: fixe Tabellenstruktur erzwingen */
}

/* Kopf- und Datenzellen allgemein */
#entriesList th, #entriesList td {
  padding: 0.5em 0.8em;
  border: 1px solid #ccc;
  vertical-align: middle;
  word-wrap: break-word; /* lange W√∂rter umbrechen */
}

/* Fixe Breiten f√ºr spezifische Spalten setzen 
#entriesList th:nth-child(1), #entriesList td:nth-child(1) { width: 100px; } /* Datum 
#entriesList th:nth-child(2), #entriesList td:nth-child(2) { width: 80px; }  /* Start 
#entriesList th:nth-child(3), #entriesList td:nth-child(3) { width: 80px; }  /* Ende 
#entriesList th:nth-child(4), #entriesList td:nth-child(4) { width: 90px; }  /* Dauer 
#entriesList th:nth-child(5), #entriesList td:nth-child(5) { width: 120px; } /* Kategorie 
#entriesList th:nth-child(6), #entriesList td:nth-child(6) { 
  width: 250px; /* Beschreibung fixe Breite 
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}
#entriesList th:nth-child(7), #entriesList td:nth-child(7) { width: 150px; } /* Aktion */

/* Fixe Breiten f√ºr spezifische Spalten setzen */
#entriesList th:nth-child(1), #entriesList td:nth-child(1) { width: 85px; } /* Datum */
#entriesList th:nth-child(2), #entriesList td:nth-child(2) { width: 40px; }  /* Start */
#entriesList th:nth-child(3), #entriesList td:nth-child(3) { width: 40px; }  /* Ende */
#entriesList th:nth-child(4), #entriesList td:nth-child(4) { width: 120px; } /* Kategorie */
#entriesList th:nth-child(5), #entriesList td:nth-child(5) { 
  width: 150px; /* Beschreibung fixe Breite */
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}
#entriesList th:nth-child(6), #entriesList td:nth-child(6) { width: 180px; } /* Aktion */

/* Button-Zelle */
.entry-actions {
  display: flex;
  gap: 0.3em;
  flex-wrap: nowrap;
}

/* Buttons kompakt */
.entry-btn {
  font-size: 0.8em;
  padding: 0.3em 0.5em;
  white-space: nowrap;
  border: 1px solid #bbb;
  background: #eee;
  border-radius: 3px;
  cursor: pointer;
}

body {
  font-family: sans-serif;
  margin: 0;
  padding: 0 1em;
  background: #f7f7f7;
  font-size: 1.05em;
}

input, select, textarea, button {
  font-size: 1em;
  padding: 0.5em;
  width: 100%;
  max-width: 300px;
  margin-top: 0.3em;
}

.section {
  display: none;
  padding: 1.5em 1em;
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  margin: 2em auto;
  max-width: 900px;
}

.section.active {
  display: block;
}

#manual.section,
#stopwatch.section {
  display: none;
  padding: 1.5em 1em;
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  margin: 2em auto;
  max-width: 500px; /* gezielte Begrenzung */
  width: 100%;
}

#manual.section.active,
#stopwatch.section.active {
  display: block;
}


#manual form,
#stopwatch form {
  margin: 0 auto;
  max-width: 500px;
  display: flex;
  flex-direction: column;
  align-items: center;
}

#manual form > *,
#stopwatch form > * {
  width: 100%;
  max-width: 400px;
}

.section h2 {
  text-align: center;
  margin-bottom: 1em;
}

/*
.section {
  display: none;
  padding: 2em 1.5em;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.05);
  margin: 2em auto;
  max-width: 600px;  zentrierte, angenehme Breite f√ºr Eingabe 
  width: 100%;
}

.section.active {
  display: block;
} */

.modal-group {
  display: flex;
  justify-content: space-between;
  gap: 2em; /* echter Abstand zwischen Feldern */
  margin-bottom: 1em;
}

.modal-group > div {
  width: 48%; /* so bleibt L√ºcke sichtbar */
  display: flex;
  flex-direction: column;
}

/*Modal*/
#editModal {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #fff;
  padding: 20px;
  border: 1px solid #ccc;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
  z-index: 1000;
  width: 600px;
  border-radius: 12px;
}

#editModal label {
  margin-top: 1em;
  font-weight: 500;
}

#editModal input,
#editModal select,
#editModal textarea {
  width: 100%;
  padding: 0.5em;
  font-size: 1em;
  margin-top: 0.3em;
  box-sizing: border-box;
}


.modal-buttons {
  display: flex;
  gap: 1em;
  justify-content: center;
  margin-top: 2em;
}

.modal-buttons button {
  padding: 0.6em 1.2em;
  font-size: 1em;
  border-radius: 6px;
  border: none;
  background: #3976e8;
  color: white;
  cursor: pointer;
  transition: background 0.2s ease;
}

.modal-buttons button:hover {
  background: #2f64c4;
}

.modal-two-cols {
  display: flex;
  gap: 2em;
  margin-top: 1em;
}

.modal-left,
.modal-right {
  flex: 1;
  display: flex;
  flex-direction: column;
}

.modal-row {
  display: flex;
  gap: 1em;
  margin-top: 1em;
}

.modal-row > div {
  flex: 1;
  display: flex;
  flex-direction: column;
}

.modal-right textarea {
  height: 100%;
  min-height: 180px;
  resize: vertical;
}

.entry-filters {
  display: flex;
  flex-wrap: wrap;
  gap: 2em;
  justify-content: space-between;
  align-items: flex-end;
  margin-bottom: 1.5em;
  max-width: 1100px;
  margin-left: auto;
  margin-right: auto;
}

.entry-filters > div {
  flex: 1;
  min-width: 280px;
}

.date-range-inline {
  display: flex;
  gap: 1em;
  margin-top: 0.5em;
  align-items: flex-end;
}

.date-range-inline label {
  display: flex;
  flex-direction: column;
  font-weight: normal;
}

.date-range {
  display: flex;
  gap: 1em;
  margin-top: 0.5em;
}

/* Timeline-Tabellen in √úbersicht */
#overviewTimelineTable table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 1em;
}

#overviewTimelineTable th,
#overviewTimelineTable td {
  border: 1px solid #ccc;
  padding: 0.4em 0.6em;
  text-align: left;
  vertical-align: top;
  font-size: 0.95em;
}

#overviewTimelineTable th.zeitraum {
  width: 100px;
  white-space: nowrap;
}

#overviewTimelineTable th.wochentag,
#overviewTimelineTable th.datum,
#overviewTimelineTable td.wochentag,
#overviewTimelineTable td.datum {
  width: 120px;
  white-space: nowrap;
}

/*
#authButton {
  position: fixed;
  top: 10px;
  right: 10px;
  width: 200px;
  font-size: 12px;
  height: 36px;
  padding: 0 8px;
  background: white;
  color: #333;
  border: 1px solid #ccc;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.2s ease;
  white-space: nowrap;
  z-index: 999;
}

#authButton:hover {
  background-color: #f0f0f0;
} 
*/

#authButton {
  position: fixed;
  top: 15px;
  right: 20px;
  width: 200px;
  padding: 0.6em 0em;
  background: #ffffff;
  border: 1px solid #ccc;
  border-radius: 8px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  z-index: 999;
  white-space: nowrap;
}

#authButton:hover {
  background: #f0f0f0;
}


#openCategoryModal {
  position: fixed;
  top: 71px;
  right: 20px;
  width: 200px;
  padding: 0.6em 0em;
  background: #ffffff;
  border: 1px solid #ccc;
  border-radius: 8px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  z-index: 999;
  white-space: nowrap;
}

#openCategoryModal:hover {
  background: #f0f0f0;
}


#loginModal {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.3);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

#loginContent {
  background: #fff;
  padding: 2em;
  border-radius: 10px;
  width: 300px;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}

/*Footer*/
.footer {
  background: linear-gradient(90deg, #e0eafc, #cfdef3);
  color: #2c3e50;
  padding: 2em 1em;
  font-size: 15px;
  font-weight: 500;
  text-align: center;
  box-shadow: 0 -2px 15px rgba(0, 0, 0, 0.05);
  border-top: 1px solid #d0d0d0;
  letter-spacing: 0.3px;
}

.footer a {
  color: #3976e8;
  text-decoration: none;
  font-weight: 600;
}

.footer a:hover {
  text-decoration: underline;
  color: #2f64c4;
}


.category-dropdown {
  position: relative;
  width: 100%;
  max-width: 300px;
  user-select: none;
}

.selected-option {
  padding: 0.5em;
  border: 1px solid #ccc;
  border-radius: 5px;
  cursor: pointer;
  background: #fff;
}

.dropdown-content {
  display: none;
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 1px solid #ccc;
  border-top: none;
  z-index: 1000;
  max-height: 250px;
  overflow: hidden;
}

.category-search {
  width: 100%;
  box-sizing: border-box;
  padding: 0.5em;
  border: none;
  border-bottom: 1px solid #ddd;
  outline: none;
}

.options-list {
  max-height: 145px;
  overflow-y: auto;
  list-style: none;
  margin: 0;
  padding: 0;
}

.options-list li {
  padding: 0.5em;
  cursor: pointer;
}

.options-list li:hover {
  background-color: #f0f0f0;
}

/* === Global === */
body {
  font-family: 'Segoe UI', sans-serif;
  margin: 0;
  padding: 0 1em;
  background: #eef1f7; /* Heller, moderner Grundhintergrund */
  color: #2c3e50;
  font-size: 1.05em;
}

h1, h2 {
  color: #2c3e50;
}

.section h2 {
  font-size: 1.6em;
  text-align: center;
  margin-bottom: 1em;
  color: #1e355e;
  font-weight: 600;
  letter-spacing: 0.5px;
}

label {
  display: block;
  margin-top: 1em;
  font-weight: 500;
}

input, select, textarea, button {
  font-size: 1em;
  padding: 0.5em 0.6em;
  border-radius: 6px;
  border: 1px solid #ccc;
  background: white;
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  width: 100%;
  max-width: 300px;
  margin-top: 0.3em;
  box-sizing: border-box;
}

textarea {
  height: 100px;
  resize: vertical;
}

button {
  background-color: #3976e8; /* Satteres Blau */
  color: white;
  border: none;
  transition: background 0.2s ease;
  cursor: pointer;
}

button:hover {
  background-color: #2f64c4;
}

form {
  max-width: 320px;
  width: 100%;
}

/* === Layout Sections === */
.section {
  display: none;
  padding: 2em 1.5em;
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
  margin: 2em auto;
  max-width: 900px;
}

.section.active {
  display: block;
}

/* === Tab Navigation === */
#tabs {
  display: flex;
  justify-content: center;
  gap: 0.5em;
  padding: 1em;
  background: #dbe3f2; /* Neue helle Akzentfarbe */
  border-radius: 12px;
  box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.05);
  max-width: 900px;
  margin: 2em auto;
}

#tabs button {
  padding: 0.6em 1.2em;
  background: #c8d4ee; /* etwas kr√§ftigerer Standardzustand */
  border: 1px solid #b0bfdc;
  border-radius: 8px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  color: #2c3e50;
}

#tabs button:hover {
  background: #b6c6e2;
}

#tabs button.active-tab {
  background: #3976e8;
  color: white;
  border-color: #3976e8;
  font-weight: bold;
}

/* === Overview Tabs === */
#overviewTabs {
  display: flex;
  justify-content: center;
  gap: 0.5em;
  margin-bottom: 1.5em;
}

#overviewTabs button {
  padding: 0.4em 1.2em;
  font-size: 0.9em;
  background: #c8d4ee;
  border: 1px solid #b0bfdc;
  border-radius: 20px;
  cursor: pointer;
  transition: background 0.2s ease;
  color: #2c3e50;
  font-weight: 500;
}

#overviewTabs button:hover {
  background: #b6c6e2;
}

#overviewTabs button.active-overview {
  background: #3976e8;
  color: white;
  font-weight: bold;
  border-color: #3976e8;
}

/* === WeekNav Buttons === */
#weekNav {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 0.5em;
  margin-bottom: 1em;
  flex-wrap: wrap;
}

#weekNav button {
  background: #c8d4ee;
  color: #2c3e50;
  border: 1px solid #b0bfdc;
  padding: 0.2em 0.6em;
  font-size: 0.9em;
  line-height: 1.2;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.2s ease;
  min-width: auto;
  width: auto;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

#weekNav button:hover {
  background: #b6c6e2;
  color: #1f2d3d;
}

/* === Fix f√ºr schlecht sichtbare "Bearbeiten/L√∂schen" Buttons === */
.entry-btn {
  font-size: 0.8em;
  padding: 0.4em 0.6em;
  border-radius: 5px;
  background: #e6ebf5;
  color: #2c3e50;
  border: 1px solid #ccc;
  white-space: nowrap;
  cursor: pointer;
  transition: background 0.2s ease;
}

.entry-btn:hover {
  background: #d0d7e5;
  color: #000;
}

/* === Auth & Kategorie-Button === */
#authButton,
#openCategoryModal {
  position: fixed;
  right: 20px;
  padding: 0.6em 1em;
  background: #c8d4ee;
  border: 1px solid #b0bfdc;
  border-radius: 8px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  z-index: 999;
  white-space: nowrap;
  color: #2c3e50;
}

#authButton:hover,
#openCategoryModal:hover {
  background: #b6c6e2;
  color: #1f2d3d;
}

#authButton {
  top: 15px;
}

#openCategoryModal {
  top: 71px;
}

#confirmCancel:hover {
  background: #2f64c4;
}

.pagination-wrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.4em;
}

.pagination-buttons {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.3em;
}

.pagination-btn {
  padding: 0.2em 0.4em; /* kleiner Padding */
  font-size: 0.85em;    /* kleiner Schrift */
  min-width: 90px;      /* Fixe kleine Breite (passt zum l√§ngsten Wort "Vorherige") */
  border-radius: 6px;
  border: none;
  background-color: #e4eaf3;
  color: #3976e8;
  cursor: pointer;
  transition: background-color 0.2s ease;
}

.pagination-btn:hover:not(:disabled) {
  background-color: #d4ddef;
}

.pagination-btn:disabled {
  background-color: #f0f0f0;
  color: #aaa;
  cursor: not-allowed;
}

.pagination-info {
  font-size: 0.9em;
  text-align: center;
  white-space: nowrap;     /* Verhindert Zeilenumbr√ºche */
  display: flex;           /* Nebeneinander positionieren */
  gap: 0.3em;              /* Abstand zwischen W√∂rtern einstellen */
  align-items: center;     /* Vertikal zentrieren */
  justify-content: center; /* Horizontal zentrieren */
}


.pagination-jump {
  display: flex;
  align-items: center;
  gap: 0.4em;
  font-size: 0.9em;
  margin-bottom: 0.3em;
}

.pagination-jump input {
  width: 3em;
  padding: 0.2em;
  font-size: 0.9em;
  text-align: center;
  border: 1px solid #ccc;
  border-radius: 4px;
}

</style>
</head>
<body>
  <div id="messageBox" style="
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.9);
  background: #333;
  color: white;
  padding: 1em 1.5em;
  border-radius: 12px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.2);
  font-weight: 500;
  z-index: 10000;
  display: none;
  opacity: 0;
  transition: opacity 0.3s ease, transform 0.3s ease;
  pointer-events: none;
  text-align: center;
  min-width: 220px;
  max-width: 80%;
"></div>


  <button id="authButton" onclick="toggleLoginModal()">Status: Nicht eingeloggt</button>
  

  <div id="loginModal">
    <div id="loginContent">
      
     <!-- Login-Formular -->
     <div id="loginForm">
      <input type="email" id="email" placeholder="Email"><br><br>
      <div style="position: relative; width: 100%; max-width: 300px;">
        <input
          type="password"
          id="password"
          placeholder="Passwort"
          style="width: 100%; padding-right: 1em; box-sizing: border-box; height: 2.5em;"
        >
        <!--
        <button
          type="button"
          onclick="togglePasswordVisibility()"
          id="togglePasswordBtn"
          style="
            position: absolute;
            right: 10px;
            top: 0;
            bottom: 0;
            margin: auto;
            height: 1.2em;
            font-size: 0.75em;
            background: none;
            border: none;
            color: #7c838a;
            text-decoration: underline;
            cursor: pointer;
            padding: 0;
          "
        >Show</button>
      -->
      </div>

      <br><br>

      <button onclick="login()">Login</button><br><br>
    </div>


      
      <!-- Eingeloggt-Anzeige -->
      <div id="loggedInInfo" style="display: none;">
        <p id="userEmail" style="margin-bottom: 1em;"></p>
        <button onclick="logout()">Logout</button><br><br>
      </div>
  
      <button onclick="toggleLoginModal()">Schliessen</button>
    </div>
  </div>

  <!-- Kategorien Button -->
<button id="openCategoryModal">Kategorien</button>

<!-- Modal -->
<!-- Haupt-Modal: Kategorien√ºbersicht -->
<div id="categoryModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 1000; justify-content: center; align-items: center;">
  <div style="background: white; padding: 2em; border-radius: 10px; width: 500px; max-height: 80vh;">
    <h3>Kategorien verwalten</h3>

<!--Suchfeld-->
<label for="categorySearch">Kategorie suchen:</label>
<input type="text" id="categorySearch" placeholder="z.‚ÄØB. Arbeit" style="width: 100%; margin-bottom: 1em;">

    <!-- nur dieser Teil darf scrollen -->
    <div style="max-height: 300px; overflow-y: auto; margin-bottom: 1em;">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr>
            <th style="text-align: left;">Name</th>
            <th>Farbe</th>
            <th>Aktionen</th>
          </tr>
        </thead>
        <tbody id="categoryList"></tbody>
      </table>
    </div>

    <div style="display: flex; justify-content: space-between; gap: 1em;">
      <button onclick="openNewCategoryModal()">+ Neue Kategorie</button>
      <button onclick="closeCategoryModal()">Schliessen</button>
    </div>
  </div>
</div>


<!-- Unter-Modal: Neue Kategorie erstellen -->
<div id="newCategoryModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 1001; justify-content: center; align-items: center;">
  <div style="background: white; padding: 2em; border-radius: 10px; width: 400px;">
    <h3>Neue Kategorie hinzuf√ºgen</h3>
    <label>Name:</label>
    <input id="newCategoryName" placeholder="z.B. Fokusarbeit">
    <label>Farbe:</label>
    <input type="color" id="newCategoryColor" value="#888888">
    <input type="text" id="newCategoryHex" value="#888888" placeholder="#888888">
    <small style="display: block; margin-top: 0.5em;">
      <a href="https://coolors.co/palettes/trending" target="_blank" style="color: #0077cc; text-decoration: underline;">Farbinspiration: coolors.co</a>
    </small>

    <div style="margin-top: 1.5em; display: flex; gap: 1em;">
      <button style="flex: 1;" onclick="addCategoryFromModal()">Speichern</button>
      <button style="flex: 1;" onclick="closeNewCategoryModal()">Abbrechen</button>
    </div>
  </div>
</div>

<!-- Modal: Kategorie bearbeiten -->
<div id="editCategoryModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 1001; justify-content: center; align-items: center;">
  <div style="background: white; padding: 2em; border-radius: 10px; width: 400px;">
    <h3>Kategorie bearbeiten</h3>
    <label>Name:</label>
    <input id="editCategoryName">
    <label>Farbe:</label>
    <input type="color" id="editCategoryColor">
    <input type="text" id="editCategoryHex">
    <small style="display: block; margin-top: 0.5em;">
      <a href="https://coolors.co/palettes/trending" target="_blank" style="color: #0077cc; text-decoration: underline;">Farbinspiration: coolors.co</a>
    </small>
    <div style="margin-top: 1.5em; display: flex; gap: 1em;">
      <button style="flex: 1;" onclick="saveEditedCategory()">Speichern</button>
      <button style="flex: 1;" onclick="closeEditCategoryModal()">Abbrechen</button>
    </div>
  </div>
</div>


  


<div id="tabs">
<button id="tab-manual" onclick="switchSection('manual')">Manuelle Eingabe</button>
<button id="tab-stopwatch" onclick="switchSection('stopwatch')">Stoppuhr</button>
<button id="tab-overview" onclick="switchSection('overview')">√úbersicht</button>
<button id="tab-entries" onclick="switchSection('entries')">Eintr√§ge</button>
</div>

<!--Firebase Login-->
<!--
<div id="loginDiv" style="margin: 2em auto; max-width: 400px;">
  <input type="email" id="email" placeholder="Email" />
  <input type="password" id="password" placeholder="Passwort" />
  <button onclick="login()">Login</button>
</div>

<button onclick="logout()" style="display:none; margin: 1em auto; display: block;" id="logoutBtn">Logout</button>
-->

<!-- Manuelle Eingabe -->
<div class="section active" id="manual">
<h2>Manuelle Eingabe</h2>
<form id="manualForm">
<label for="dateInput">Datum:</label>
<input id="dateInput" required="" type="date"/>
<div class="inline-group">
<div class="field-third">
<label for="startTimeInput">Startzeit:</label>
<input id="startTimeInput" required="" type="time" oninput="updateDurationAndEndTime('end')"/>
</div>
<div class="field-third">
<label for="endTimeInput">Endzeit:</label>
<input id="endTimeInput" type="time" oninput="updateDurationAndEndTime('end')" />
</div>
<div class="field-third">
<label for="durationInput">Dauer:</label>
<input id="durationInput" placeholder="--:--" type="text" oninput="updateDurationAndEndTime('duration')"/>
</div>
</div>

<label for="categoryInput">Kategorie:</label>
<div class="category-dropdown">
  <div id="categorySelected" class="selected-option" onclick="toggleCategoryDropdown()">Kategorie w√§hlen</div>
  <div id="categoryDropdownContent" class="dropdown-content">
    <input type="text" id="categorySearchInput" placeholder="Kategorie suchen..." class="category-search">
    <ul id="categoryOptions" class="options-list"></ul>
  </div>
</div>

<!--
<label for="categoryInput">Kategorie:</label>
<select id="categoryInput"></select>
-->

<label for="descriptionInput">Beschreibung:</label>
<textarea id="descriptionInput" placeholder="Mehrzeiliger Text, Abs√§tze m√∂glich..."></textarea>
<button type="submit">Eintrag speichern</button>
<div id="firebaseError" style="color: red; font-weight: bold; margin-top: 1em;"></div>

</form>
</div>
<script>

  //Seiten bei Entries
  let currentPage = 1;
  const entriesPerPage = 30;

  function renderPaginationControls(totalEntries) {
  const totalPages = Math.ceil(totalEntries / entriesPerPage);
  const paginationContainer = document.getElementById('paginationControls');
  
  if (totalPages <= 1) {
    paginationContainer.innerHTML = '';
    return;
  }

  paginationContainer.innerHTML = `
  <div class="pagination-wrapper">
    <div class="pagination-jump">
      Gehe zu Seite: 
      <input type="number" id="pageJumpInput" min="1" max="${totalPages}" placeholder="#" 
             onkeydown="if(event.key==='Enter'){jumpToPage(${totalPages});}" 
             onblur="jumpToPage(${totalPages})"/>
    </div>

    <div class="pagination-buttons">
      <button class="pagination-btn" onclick="changePage(1)" ${currentPage === 1 ? 'disabled' : ''}>
        &laquo; Erste
      </button>
      <button class="pagination-btn" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
        &lsaquo; Vorherige
      </button>

      <span class="pagination-info">Seite ${currentPage} von ${totalPages}</span>

      <button class="pagination-btn" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
        N√§chste &rsaquo;
      </button>
      <button class="pagination-btn" onclick="changePage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>
        Letzte &raquo;
      </button>
    </div>
  </div>
`;

}

function jumpToPage(totalPages) {
  const input = document.getElementById('pageJumpInput');
  let pageNum = parseInt(input.value, 10);

  if (!isNaN(pageNum) && pageNum >= 1 && pageNum <= totalPages) {
    currentPage = pageNum;
    updateEntries();
  } else {
    input.value = '';  // Reset bei ung√ºltiger Eingabe
  }
}


function changePage(pageNum) {
  currentPage = pageNum;
  updateEntries();
}


  function customConfirm(message, onConfirm) {
  const modal = document.getElementById('confirmModal');
  const text = document.getElementById('confirmText');
  const cancelBtn = document.getElementById('confirmCancel');
  const okBtn = document.getElementById('confirmOK');

  text.textContent = message;
  modal.style.display = 'flex';

  cancelBtn.onclick = () => {
    closeConfirmModal(); // ‚úÖ benutzt die zentrale Cleanup-Logik
  };

  okBtn.onclick = () => {
    closeConfirmModal(); // ‚úÖ Modal sauber schlie√üen
    onConfirm();         // ‚úÖ Aktion ausf√ºhren
  };

  setupClickOutsideClose('confirmModal', '#confirmModal > div', closeConfirmModal);
}



  function closeConfirmModal() {
  const modal = document.getElementById('confirmModal');
  modal.style.display = 'none';

  const cancelBtn = document.getElementById('confirmCancel');
  const okBtn = document.getElementById('confirmOK');

  cancelBtn.onclick = null;
  okBtn.onclick = null;

  if (outsideClickHandlers['confirmModal']) {
    document.removeEventListener('click', outsideClickHandlers['confirmModal']);
    outsideClickHandlers['confirmModal'] = null;
  }
  justClosedModal = true;
setTimeout(() => { justClosedModal = false; }, 50);

}



function showMessage(text, type = 'info') {
  const box = document.getElementById('messageBox');
  box.innerHTML = text;

  const colors = {
    success: '#4CAF50',  // gr√ºn
    error: '#f44336',    // rot
    warning: '#ff9800',  // orange
    info: '#333'         // grau
  };

  box.style.background = colors[type] || colors.info;

  box.style.display = 'block';
  box.style.opacity = '0';
  box.style.transform = 'translate(-50%, -50%) scale(0.9)';

  // Animation rein (opacity + pop)
  setTimeout(() => {
    box.style.opacity = '1';
    box.style.transform = 'translate(-50%, -50%) scale(1)';
  }, 10);

  // Nach 2 Sekunden ausblenden
  setTimeout(() => {
    box.style.opacity = '0';
    box.style.transform = 'translate(-50%, -50%) scale(0.9)';
    setTimeout(() => {
      box.style.display = 'none';
    }, 300);
  }, 2000);
}


window.data = [];

window.categories = {
  "Fluid Dynamics": "#1F77B4",    // k√ºhles Blau ‚Äì technisch & dynamisch
  "SML": "#D62728",               // kr√§ftiges Rot ‚Äì signalstark und pr√§sent
  "Quantum Mechanics": "#9467BD",// violett ‚Äì ein bisschen mystisch, passend zum Thema
  "WuF": "#2CA02C",               // sattes Gr√ºn ‚Äì frisch & verst√§ndlich
  "Thermo II": "#FF7F0E",         // warmes Orange ‚Äì energiegeladen
  "Thermo III": "#8C564B"         // erdiges Braun ‚Äì tiefer, ernster Stoff
};

  let lastManualDate = null;

  function formatDate(date) {
    return date.toISOString().split('T')[0];
  }
  function formatDisplayDate(dateStr) {
  const [y, m, d] = dateStr.split("-");
  return `${d}.${m}.${y}`;
}

  function switchSection(id) {
    // Merke Datum, wenn wir "Manuelle Eingabe" verlassen
    const wasManual = document.getElementById('manual').classList.contains('active');
    if (wasManual) {
      const current = document.getElementById('dateInput')?.value;
      if (current) lastManualDate = current;
    }

    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('#tabs button').forEach(b => b.classList.remove('active-tab'));
    document.getElementById(id).classList.add('active');
    document.getElementById(`tab-${id}`).classList.add('active-tab');

    if (id === 'manual') {
      document.getElementById('dateInput').value = lastManualDate || formatDate(new Date());
    }

    if (id === 'entries') updateEntries();
    if (id === 'overview') renderOverview();
  }

  document.addEventListener('DOMContentLoaded', () => {
    populateAllCategorySelects();
    populateOverviewCategoryFilter();

    document.getElementById('dateInput').value = formatDate(new Date());

    document.getElementById('manualForm').addEventListener('submit', e => {
      e.preventDefault();
      if (!auth.currentUser) {
        showMessage("Nicht eingeloggt ‚Äì Eintrag wird nicht gespeichert.", "warning");
        return; // ‚õî Bricht die gesamte Funktion ab
      }
      const date = document.getElementById('dateInput').value;
      const startTime = document.getElementById('startTimeInput').value;
      const endTime = document.getElementById('endTimeInput').value;
      const start = new Date(`${date}T${startTime}`);
let end = new Date(`${date}T${endTime}`);
let crossedMidnight = false;

if (end <= start) {
  end.setDate(end.getDate() + 1);
  crossedMidnight = true;
}

const category = window.selectedCategory;
if (!category) {
  showMessage("Bitte eine Kategorie ausw√§hlen.", "warning");
  return;
}
const color = categories[category];
const description = document.getElementById('descriptionInput').value;

if (crossedMidnight) {
  // Teilt bei Mitternacht
  const midnight = new Date(start);
  midnight.setHours(24, 0, 0, 0); // erzeugt 00:00 des n√§chsten Tages

  const duration1 = (midnight - start) / (1000 * 60 * 60);
  const duration2 = (end - midnight) / (1000 * 60 * 60);

  const nextDate = formatDate(new Date(start.getTime() + 24 * 60 * 60 * 1000)); // sicher korrektes Datum
  const endTimeFormatted = end.toTimeString().slice(0, 5);

  // Teil 1: am urspr√ºnglichen Tag (z.‚ÄØB. 22:00 ‚Äì 00:00)
  data.push({
    date,
    startTime,
    endTime: '00:00',
    duration: duration1,
    category,
    color,
    description
  });

  // Teil 2: am n√§chsten Tag (z.‚ÄØB. 00:00 ‚Äì 02:00)
  data.push({
    date: nextDate,
    startTime: '00:00',
    endTime: endTimeFormatted,
    duration: duration2,
    category,
    color,
    description
  });
} else {
  const duration = (end - start) / (1000 * 60 * 60);
  data.push({ date, startTime, endTime, duration, category, color, description });
}

if (auth.currentUser) saveEntries(auth.currentUser.uid);

document.getElementById('descriptionInput').value = '';
document.getElementById('startTimeInput').value = '';
document.getElementById('endTimeInput').value = '';
document.getElementById('durationInput').value = '';

showMessage("Eintrag gespeichert.", "success");
updateCategoryOptions();



    });
    updateOverviewDateInput();
    updateEntryDateInput();
    document.getElementById('startTimeInput').addEventListener('input', () => {
      updateDurationAndEndTime('end');
    });
    document.getElementById('endTimeInput').addEventListener('input', () => {
      updateDurationAndEndTime('end');
    });
    document.getElementById('durationInput').addEventListener('input', () => {
      updateDurationAndEndTime('duration');
    });
    setOverviewFilter('week');

    document.getElementById('editStart').addEventListener('input', () => {
      updateEditDurationAndEndTime('end');
    });
    document.getElementById('editEnd').addEventListener('input', () => {
      updateEditDurationAndEndTime('end');
    });
    document.getElementById('editDuration').addEventListener('input', () => {
      updateEditDurationAndEndTime('duration');
    });
  });

  function updateCategoryOptions() {
  const category = window.currentEntryCategory || 'Alle';

  sel.innerHTML = '<option value="Alle">Alle</option>';

  Object.entries(window.categories || {}).forEach(([cat, color]) => {
    const opt = document.createElement('option');
    opt.value = cat;
    opt.textContent = cat;
    opt.style.color = color;
    sel.appendChild(opt);
  });

  // üÜï Auch f√ºr √úbersicht bef√ºllen
  populateOverviewCategoryFilter();
}


//alles ab hier zu "Dauer"
  function timeToDecimal(timeStr) {
  const [h, m] = timeStr.split(':').map(Number);
  return h + (m / 60);
}

function decimalToTime(dec) {
  const totalMinutes = Math.round(dec * 60);
  const h = Math.floor(totalMinutes / 60);
  const m = totalMinutes % 60;
  return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
}
function updateDurationAndEndTime(source = '') {
  const startStr = document.getElementById('startTimeInput').value;
  const endStr = document.getElementById('endTimeInput').value;
  const durationField = document.getElementById('durationInput');

  if (!startStr) return;

  const start = timeToDecimal(startStr);

  if (source === 'end' && endStr) {
    const end = timeToDecimal(endStr);
    let diff = end - start;
    if (diff < 0) diff += 24;
    durationField.value = decimalToTime(diff);
  }

  if (source === 'duration' && durationField.value) {
    const duration = timeToDecimal(durationField.value);
    const endDecimal = (start + duration) % 24;
    document.getElementById('endTimeInput').value = decimalToTime(endDecimal);
  }
}

let stopwatchInterval = null;
  let stopwatchStart = null;
  let editingIndex = null;

  function updateEntryDateInput() {
  const type = document.getElementById('entryDateFilterType').value;
  const container = document.getElementById('entryDateInputContainer');
  const today = new Date();

  let inputField = '';

if (type === 'day') {
  const t = formatDate(today);
  inputField = `<input type="date" id="entryDateSingle" value="${t}" onchange="updateEntries()">`;
} else if (type === 'week') {
  const w = getISOWeek(today);
  const wval = `${today.getFullYear()}-W${String(w).padStart(2,'0')}`;
  inputField = `<input type="week" id="entryDateSingle" value="${wval}" onchange="updateEntries()">`;
} else if (type === 'month') {
  const m = today.toISOString().slice(0, 7);
  inputField = `<input type="month" id="entryDateSingle" value="${m}" onchange="updateEntries()">`;
} else if (type === 'year') {
  const y = today.getFullYear();
  inputField = `<input type="number" id="entryDateSingle" value="${y}" min="2000" max="2100" onchange="updateEntries()">`;
}

if (type === 'none') {
  container.innerHTML = '';
} else {
  container.innerHTML = `<div class="date-range-inline"><label>Zeitraum: ${inputField}</label></div>`;
}

  updateEntries(); // direkt aktualisieren
}
  
  function toggleStopwatch() {
    if (!auth.currentUser) {
    showMessage("Nicht eingeloggt ‚Äì du kannst die Stoppuhr nicht starten.", "warning");
    return;
    }
    const btn = document.getElementById('stopwatchButton');
    if (stopwatchInterval) {
      clearInterval(stopwatchInterval);
      stopwatchInterval = null;
      const end = new Date();
      let duration = (end - stopwatchStart) / 1000 / 60 / 60;
        if (duration < 1 / 60) {
          duration = 1 / 60; // mindestens 1 Minute
        }
      const startTime = stopwatchStart.toTimeString().substring(0,5);
      const endTime = end.toTimeString().substring(0,5);
      const date = formatDate(stopwatchStart);
      const category = window.selectedStopwatchCategory;
if (!category) {
  showMessage("Bitte eine Kategorie ausw√§hlen.", "warning");
  return;
}

      const color = categories[category];
      const description = document.getElementById('stopwatchDescription').value;
  
      /*Stoppuhr danach √ºberpr√ºfen*/
      /*if (!auth.currentUser) {
        showMessage("Nicht eingeloggt ‚Äì Eintrag wird nicht gespeichert.");
        btn.textContent = 'Start';
        document.getElementById('stopwatchDisplay').textContent = '00:00:00';
        document.getElementById('stopwatchDescription').value = '';

        stopwatchInterval && clearInterval(stopwatchInterval);
        stopwatchInterval = null;
        stopwatchStart = null;
        return; // ‚õî Funktion beenden!
      }
      */
      data.push({ date, startTime, endTime, duration, category, color, description });
      saveEntries(auth.currentUser.uid);
  
      btn.textContent = 'Start';
      document.getElementById('stopwatchDisplay').textContent = '00:00:00';
      document.getElementById('stopwatchDescription').value = '';
      renderOverview();
      updateEntries();
      showMessage("Stoppuhr-Eintrag gespeichert.", "success");
    } else {
      stopwatchStart = new Date();
      btn.textContent = 'Stop';
      stopwatchInterval = setInterval(() => {
        const diff = new Date(new Date() - stopwatchStart);
        const h = String(diff.getUTCHours()).padStart(2, '0');
        const m = String(diff.getUTCMinutes()).padStart(2, '0');
        const s = String(diff.getUTCSeconds()).padStart(2, '0');
        document.getElementById('stopwatchDisplay').textContent = `${h}:${m}:${s}`;
      }, 1000);
    }
  }

  function formatDisplayDate(dateStr) {
  if (!dateStr || !dateStr.includes("-")) return dateStr;
  const [y, m, d] = dateStr.split("-");
  return `${d}.${m}.${y}`;
}
  
  function updateEntries() {
    if (!window.data) {
  console.warn("updateEntries(): window.data fehlt ‚Äì wird initialisiert.");
  window.data = [];
}

    const category = window.currentEntryCategory || 'Alle';
    const container = document.getElementById('entriesList');
    let filtered = [...data];

    filtered.sort((a, b) => {
  if (!a.date || !b.date) return 0;
  if (a.date !== b.date) {
    return b.date.localeCompare(a.date);
  }
  if (!a.startTime || !b.startTime) return 0;
  return b.startTime.localeCompare(a.startTime);
});
  
    if (category !== 'Alle') {
      filtered = filtered.filter(e => e.category === category);
    }

    const type = document.getElementById('entryDateFilterType').value;
    const dateInput = document.getElementById('entryDateSingle');

if (type !== 'none' && dateInput) {
  const val = dateInput.value;

  if (type === 'day') {
    filtered = filtered.filter(e => e.date === val);
  } else if (type === 'week') {
    const [year, week] = val.split('-W');
    const start = getISOWeekStart(parseInt(week), parseInt(year));
    const end = new Date(start);
    end.setDate(start.getDate() + 7);
    filtered = filtered.filter(e => {
      const entryDate = new Date(e.date + "T00:00:00");
      return entryDate >= start && entryDate < end;
    });
  } else if (type === 'month') {
    filtered = filtered.filter(e => e.date.startsWith(val));
  } else if (type === 'year') {
    filtered = filtered.filter(e => e.date.startsWith(val));
  }
}
  
    if (filtered.length === 0) {
      container.innerHTML = '<p>Keine Eintr√§ge gefunden.</p>';
      return;
    }
  
    let html = '<table><thead><tr><th>Datum</th><th>Start</th><th>Ende</th><th>Dauer</th><th>Kategorie</th><th>Beschreibung</th><th>Aktion</th></tr></thead><tbody>';
        filtered.forEach((e) => {
  const dur = `${Math.floor(e.duration)}h ${Math.round((e.duration % 1) * 60)}min`;
  const originalIndex = data.indexOf(e);
  html += `<tr>
    <td>${formatDisplayDate(e.date)}</td><td>${e.startTime}</td><td>${e.endTime}</td><td>${dur}</td>
    <td style="color:${categories[e.category]}">${e.category}</td><td>${e.description || ''}</td>
    <td>
       <div class="entry-actions">
        <button onclick="openEditModal(${originalIndex})" class="entry-btn">üñäÔ∏è Bearbeiten</button>
        <button onclick="deleteEntry(${originalIndex})" class="entry-btn">üóëÔ∏è L√∂schen</button>
       </div>
    </td>
  </tr>`;
});
    html += '</tbody></table>';
    container.innerHTML = html;
  }
  
  let currentEditOriginalCategory = null; // ganz oben global

function openEditModal(index) {
  editingIndex = index;
  const e = data[index];

  currentEditOriginalCategory = e.category; // ‚úÖ merken!
  window.selectedEditCategory = e.category;

  document.getElementById('editDate').value = e.date;
  document.getElementById('editStart').value = e.startTime;
  document.getElementById('editEnd').value = e.endTime;
  document.getElementById('editDescription').value = e.description || '';
  document.getElementById('editCategorySelected').textContent = e.category;
  document.getElementById('editCategorySelected').style.color = categories[e.category];
  document.getElementById('editModal').style.display = 'block';
  setupClickOutsideClose('editModal', '#editModal', closeEditModal);

}

  
function closeEditModal() {
  editingIndex = null;
  window.selectedEditCategory = currentEditOriginalCategory;
  currentEditOriginalCategory = null;
  document.getElementById('editModal').style.display = 'none';

  if (outsideClickHandlers['editModal']) {
    document.removeEventListener('click', outsideClickHandlers['editModal']);
    outsideClickHandlers['editModal'] = null;
  }
}


  
  function saveEdit() {
    const date = document.getElementById('editDate').value;
    const start = document.getElementById('editStart').value;
    const end = document.getElementById('editEnd').value;
    const category = window.selectedEditCategory;
    if (!category) {
  showMessage("Bitte eine Kategorie ausw√§hlen.", "warning");
  return;
}
    const color = categories[category];
    const desc = document.getElementById('editDescription').value;
  
    const startDate = new Date(`${date}T${start}`);
    let endDate = new Date(`${date}T${end}`);
    if (endDate <= startDate) endDate.setDate(endDate.getDate() + 1);
    const duration = (endDate - startDate) / 1000 / 60 / 60;
  
    data[editingIndex] = { date, startTime: start, endTime: end, duration, category, color, description: desc };
    if (auth.currentUser) {
      saveEntries(auth.currentUser.uid);
    } else {
      showMessage("Nicht eingeloggt ‚Äì √Ñnderungen werden nicht gespeichert.", "warning");
    }
    closeEditModal();
    updateEntries();
    renderOverview();
    showMessage("Eintrag bearbeitet", "warning");
  }
  
  function deleteEntry(index) {
  customConfirm("Eintrag wirklich l√∂schen?", () => {
    data.splice(index, 1);

    if (auth.currentUser) {
      saveEntries(auth.currentUser.uid);
    } else {
      showMessage("Nicht eingeloggt ‚Äì √Ñnderungen werden nicht gespeichert.", "warning");
    }

    closeEditModal();
    updateEntries();
    renderOverview();
    showMessage("Eintrag gel√∂scht", "warning");
  });
}

// Gibt den Montag der ISO-Woche zur√ºck
function getISOWeekStart(week, year) {
  const jan4 = new Date(Date.UTC(year, 0, 4));
  const daysToMonday = jan4.getUTCDay() === 0 ? 6 : jan4.getUTCDay() - 1;
  const firstMonday = new Date(jan4);
  firstMonday.setUTCDate(jan4.getUTCDate() - daysToMonday);
  
  const monday = new Date(firstMonday);
  monday.setUTCDate(firstMonday.getUTCDate() + (week - 1) * 7);
  monday.setUTCHours(0, 0, 0, 0);
  
  return monday;
}


    
function getISOWeek(date) {
  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const dayNum = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
  return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
}
    
function updateOverviewDateInput() {
  const filter = window.currentOverviewFilter || 'week';
  const input = document.getElementById('overviewDate');
  const weekNav = document.getElementById('weekNav');
  const today = new Date();

  input.style.display = 'inline-block';
  weekNav.style.display = (filter === 'week') ? 'block' : 'none';

  if (filter === 'day') {
    input.type = 'date';
    input.value = formatDate(today);
  } else if (filter === 'week') {
    input.type = 'week';

    // Korrekte UTC-basierte Wochenberechnung
    const baseDate = new Date();
    baseDate.setUTCDate(baseDate.getUTCDate() + currentWeekOffset * 7);

    const weekNumber = getISOWeek(baseDate);
    const year = baseDate.getUTCFullYear();
    input.value = `${year}-W${String(weekNumber).padStart(2, '0')}`;

    const monday = getISOWeekStart(weekNumber, year); // Korrekt UTC-Montag
    const sunday = new Date(monday);
    sunday.setUTCDate(monday.getUTCDate() + 6); // Exakt UTC-Sonntag

    const mondayStr = formatDisplayDate(formatDate(monday));
    const sundayStr = formatDisplayDate(formatDate(sunday));

    weekNav.innerHTML = `
      <button onclick="changeWeek(-1)">&#8592;</button>
      <span>Woche vom ${mondayStr} bis ${sundayStr}</span>
      <button onclick="changeWeek(1)">&#8594;</button>
    `;
  } else if (filter === 'month') {
    input.type = 'month';
    input.value = today.toISOString().slice(0, 7);
  } else if (filter === 'year') {
    input.type = 'number';
    input.min = 2000;
    input.max = 2100;
    input.value = today.getUTCFullYear();
  }
}




    
function renderOverview() {
  const filter = window.currentOverviewFilter || 'week';
  const input = document.getElementById('overviewDate');
  if (!input || !input.value) return;

  // üßπ Chart-Container l√∂schen, damit kein altes Balkendiagramm bei Monat bleibt
const oldBarContainer = document.getElementById('overviewBarChartContainer');
if (oldBarContainer) oldBarContainer.remove();

  let filtered = [];

  if (filter === 'day') {
    filtered = data.filter(e => e.date === input.value);
  } else if (filter === 'week') {
    const [yearStr, weekStr] = input.value.split('-W');
    const start = getISOWeekStart(parseInt(weekStr), parseInt(yearStr));
    const end = new Date(start);
    end.setDate(start.getDate() + 7);
    filtered = data.filter(e => {
        const [y, m, d] = e.date.split('-').map(Number);
        const entryDate = new Date(Date.UTC(y, m - 1, d));
      return entryDate >= start && entryDate < end;
    });
  } else if (filter === 'month') {
    filtered = data.filter(e => e.date.startsWith(input.value));
  } else if (filter === 'year') {
    filtered = data.filter(e => e.date.startsWith(input.value));
  } else {
    filtered = [...data];
  }

  if (window.currentOverviewCategory && window.currentOverviewCategory !== 'Alle') {
  filtered = filtered.filter(e => e.category === window.currentOverviewCategory);
}


  const ctx = document.getElementById('overviewChart').getContext('2d');
  if (window.overviewChartInstance) window.overviewChartInstance.destroy();

  const summary = {};
  for (let entry of filtered) {
    if (!summary[entry.category]) summary[entry.category] = { duration: 0, color: categories[entry.category] || "#999" };
    summary[entry.category].duration += entry.duration;
  }

  const tableLabels = Object.keys(summary);
  let totalDuration = 0;
  let tableRows = '';

  tableLabels.forEach(label => {
    const duration = summary[label].duration;
    totalDuration += duration;
    const h = Math.floor(duration);
    const m = Math.round((duration - h) * 60);
    tableRows += `<tr><td style="color: ${summary[label].color}">${label}</td><td>${h}h ${m}min</td></tr>`;
  });

  const totalH = Math.floor(totalDuration);
  const totalM = Math.round((totalDuration - totalH) * 60);

  const summaryTableHTML = `
    <table>
      <thead><tr><th>Kategorie</th><th>Zeit</th></tr></thead>
      <tbody>
        <tr><td><strong>Gesamt</strong></td><td><strong>${totalH}h ${totalM}min</strong></td></tr>
        ${tableRows}
      </tbody>
    </table>
  `;
  const summaryDiv = document.getElementById('overviewSummaryTable');
  if (summaryDiv) summaryDiv.innerHTML = summaryTableHTML;

  // Doughnut-Chart
  const labels = Object.keys(summary);
  const durations = labels.map(k => summary[k].duration);
  const colors = labels.map(k => summary[k].color);

  window.overviewChartInstance = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{
        data: durations,
        backgroundColor: colors,
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: { display: true, text: 'Zeitaufteilung' },
        tooltip: {
          callbacks: {
            label: ctx => {
              const d = ctx.parsed;
              const h = Math.floor(d);
              const m = Math.round((d - h) * 60);
              return `${ctx.label}: ${h}h ${m}min`;
            }
          }
        }
      }
    }
  });

  // NEU: Bar Chart (au√üer bei Monat)
  if (filter !== 'month') {
    renderOverviewBarChart(filtered, filter);
  }

  // Timeline-Tabelle
  const timelineDiv = document.getElementById('overviewTimelineTable');
  let timelineHTML = '';

  const formatTime = (dec) => {
    const h = Math.floor(dec);
    const m = Math.round((dec - h) * 60);
    return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
  };

  const groupAndFormat = (grouped) => {
    return Object.entries(grouped)
      .map(([cat, dur]) => `<span style="color:${summary[cat]?.color || '#000'}">${cat}: ${formatTime(dur)}</span>`)
      .join(' | ');
  };

  if (filter === 'day') {
    const intervals = Array.from({ length: 12 }, (_, i) => ({
      start: i * 2,
      label: `${String(i * 2).padStart(2, '0')}:00 ‚Äì ${String(i * 2 + 2).padStart(2, '0')}:00`
    }));

    timelineHTML += '<table><thead><tr><th class="zeitraum">Zeitraum</th><th>Details</th></tr></thead><tbody>';
    intervals.forEach(interval => {
      const grouped = {};
      filtered.forEach(e => {
        
  const start = new Date(`${e.date}T${e.startTime}`);
  const end = new Date(`${e.date}T${e.endTime}`);
// ‚ûï Falls der Eintrag √ºber Mitternacht geht ‚Üí n√§chsten Tag hinzuf√ºgen
if (end <= start) {
  end.setDate(end.getDate() + 1);
}
  const intervalStart = new Date(start);
  intervalStart.setHours(interval.start, 0, 0, 0);
  const intervalEnd = new Date(intervalStart);
  intervalEnd.setHours(interval.start + 2, 0, 0, 0);

  const overlapStart = start > intervalStart ? start : intervalStart;
  const overlapEnd = end < intervalEnd ? end : intervalEnd;

  if (overlapStart < overlapEnd) {
    const overlapHours = (overlapEnd - overlapStart) / (1000 * 60 * 60);
    grouped[e.category] = (grouped[e.category] || 0) + overlapHours;
  }
});



      timelineHTML += `<tr><td>${interval.label}</td><td>${Object.keys(grouped).length ? groupAndFormat(grouped) : 'Keine Eintr√§ge'}</td></tr>`;
    });
    timelineHTML += '</tbody></table>';

  } else if (filter === 'week') {
    const days = ['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'];
    const [yearStr, weekStr] = input.value.split('-W');
    const start = getISOWeekStart(parseInt(weekStr), parseInt(yearStr));

    timelineHTML += '<table><thead><tr><th class="wochentag">Wochentag</th><th class="datum">Datum</th><th>Details</th></tr></thead><tbody>';
    for (let i = 0; i < 7; i++) {
      const d = new Date(start);
      d.setDate(start.getDate() + i);
      const iso = formatDate(d);
      const dayName = days[d.getDay()];
      const dateStr = formatDisplayDate(iso);
      const grouped = {};
      filtered.forEach(e => {
        if (e.date === iso) {
          grouped[e.category] = (grouped[e.category] || 0) + e.duration;
        }
      });
      timelineHTML += `<tr>
        <td class="wochentag">${dayName}</td>
        <td class="datum">${dateStr}</td>
        <td>${Object.keys(grouped).length ? groupAndFormat(grouped) : 'Keine Eintr√§ge'}</td>
      </tr>`;
    }
    timelineHTML += '</tbody></table>';

  } else if (filter === 'year') {
    const months = ['Januar','Februar','M√§rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
    const yearVal = input.value;

    timelineHTML += '<table><thead><tr><th class="zeitraum">Monat</th><th>Details</th></tr></thead><tbody>';
    for (let m = 0; m < 12; m++) {
      const monthStr = `${yearVal}-${String(m + 1).padStart(2, '0')}`;
      const label = months[m];
      const grouped = {};
      filtered.forEach(e => {
        if (e.date.startsWith(monthStr)) {
          grouped[e.category] = (grouped[e.category] || 0) + e.duration;
        }
      });
      timelineHTML += `<tr><td>${label}</td><td>${Object.keys(grouped).length ? groupAndFormat(grouped) : 'Keine Eintr√§ge'}</td></tr>`;
    }
    timelineHTML += '</tbody></table>';
  }

  timelineDiv.innerHTML = timelineHTML;
}


    function renderOverviewBarChart(filtered, filter) {
  const containerId = 'overviewBarChartContainer';
  let container = document.getElementById(containerId);
  if (!container) {
    container = document.createElement('div');
    container.id = containerId;
    container.style = 'height: 400px; max-width: 900px; margin: 2em auto;';
    const timelineDiv = document.getElementById('overviewTimelineTable');
overview.insertBefore(container, timelineDiv);
  }
  container.innerHTML = '<canvas id="overviewBarChart"></canvas>';
  const ctx = document.getElementById('overviewBarChart').getContext('2d');

  if (window.overviewBarChartInstance) {
    window.overviewBarChartInstance.destroy();
  }

  const categorySet = new Set(filtered.map(e => e.category));
const categoryList = Array.from(categorySet);

const categoryColors = window.categories || {}; // ‚Üê hier holst du die Farbtabelle

let labels = [];
let datasets = categoryList.map(cat => ({
  label: cat,
  data: [],
  backgroundColor: categoryColors[cat] || '#888'
}));


  if (filter === 'day') {
    for (let i = 0; i < 24; i += 2) {
      labels.push(`${String(i).padStart(2, '0')}-${String(i + 2).padStart(2, '0')}`);
    }
    datasets.forEach(ds => ds.data = new Array(labels.length).fill(0));
    filtered.forEach(e => {
      const start = timeToDecimal(e.startTime);
      const end = timeToDecimal(e.endTime);
      let s = start;
      let eDec = end < start ? end + 24 : end;
      for (let i = 0; i < labels.length; i++) {
        const blockStart = i * 2;
        const blockEnd = blockStart + 2;
        const overlap = Math.max(0, Math.min(eDec, blockEnd) - Math.max(s, blockStart));
        if (overlap > 0) {
          const ds = datasets.find(d => d.label === e.category);
          ds.data[i] += overlap;
        }
      }
    });

} else if (filter === 'week') {
  const days = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
  const [year, week] = document.getElementById('overviewDate').value.split('-W').map(Number);
const weekStart = getISOWeekStart(week, year);

// Labels setzen
labels = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
datasets.forEach(ds => ds.data = new Array(7).fill(0));

// Zuordnung pro Tag (Differenz in Tagen zur Woche)
filtered.forEach(e => {
    const entryDateStr = e.date;
const entryDateParts = entryDateStr.split('-').map(Number);
const entryDateObj = new Date(entryDateParts[0], entryDateParts[1] - 1, entryDateParts[2]);
// Setze Uhrzeit explizit auf Mitternacht (lokal)
entryDateObj.setHours(0, 0, 0, 0);

const weekStartCopy = new Date(weekStart); // sicherstellen, dass wir nichts ver√§ndern
weekStartCopy.setHours(0, 0, 0, 0);

entryDateObj.setHours(0, 0, 0, 0);
weekStart.setHours(0, 0, 0, 0);

for (let i = 0; i < 7; i++) {
  const day = new Date(weekStart);
  day.setDate(weekStart.getDate() + i);
  day.setHours(0, 0, 0, 0);

  if (entryDateObj.getTime() === day.getTime()) {
    const ds = datasets.find(d => d.label === e.category);
    ds.data[i] += e.duration;
  }
}
});

}
 else if (filter === 'year') {
    const months = ['Jan', 'Feb', 'M√§r', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
    labels = months;
    datasets.forEach(ds => ds.data = new Array(12).fill(0));
    filtered.forEach(e => {
      const d = new Date(e.date);
      const m = d.getMonth();
      const ds = datasets.find(d => d.label === e.category);
      ds.data[m] += e.duration;
    });
  }

  window.overviewBarChartInstance = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { stacked: true },
        y: {
          stacked: true,
          beginAtZero: true,
          ticks: {
            callback: value => {
              const h = Math.floor(value);
              const m = Math.round((value - h) * 60);
              return `${h}h ${m}min`;
            }
          }
        }
      },
      plugins: {
        legend: {
          display: false // ‚Üê einfach & sicher
        },
        tooltip: {
          callbacks: {
            label: ctx => {
              const d = ctx.parsed.y;
              const h = Math.floor(d);
              const m = Math.round((d - h) * 60);
              return `${ctx.dataset.label}: ${h}h ${m}min`;
            }
          }
        },
        title: {
          display: true,
          text: 'Zeitverteilung (Balkendiagramm)'
        }
      }
    }
  });
}


    
    let currentWeekOffset = 0;

function setOverviewFilter(type) {
  window.currentOverviewFilter = type;
  currentWeekOffset = 0; // Reset wenn Filter ge√§ndert wird

  document.querySelectorAll('#overviewTabs button').forEach(btn => {
    btn.classList.remove('active-overview');
  });
  document.getElementById(`btn-filter-${type}`).classList.add('active-overview');

  updateOverviewDateInput();
  renderOverview();
}

function updateOverviewCategory() {
  const sel = document.getElementById('overviewCategoryFilter');
  window.currentOverviewCategory = sel.value;
  renderOverview(); // ‚¨ÖÔ∏è neu rendern!
}

function populateOverviewCategoryFilter() {
  const sel = document.getElementById('overviewCategoryFilter');
  if (!sel) return;

  sel.innerHTML = '<option value="Alle">Alle</option>';

  // Hole aus window.categories dynamisch
  if (window.categories) {
    Object.entries(window.categories).forEach(([cat, color]) => {
      const opt = document.createElement('option');
      opt.value = cat;
      opt.textContent = cat;
      opt.style.color = color;
      sel.appendChild(opt);
    });
  }
}



function changeWeek(offset) {
  currentWeekOffset += offset;

  const input = document.getElementById('overviewDate');
  const current = new Date();
  current.setDate(current.getDate() + currentWeekOffset * 7);

  const week = getISOWeek(current);
  const year = current.getFullYear();
  input.value = `${year}-W${String(week).padStart(2, '0')}`;

  updateOverviewDateInput();
  renderOverview();
}

function updateEditDurationAndEndTime(source = '') {
  const startStr = document.getElementById('editStart').value;
  const endStr = document.getElementById('editEnd').value;
  const durationField = document.getElementById('editDuration');

  if (!startStr) return;

  const start = timeToDecimal(startStr);

  if (source === 'end' && endStr) {
    const end = timeToDecimal(endStr);
    let diff = end - start;
    if (diff < 0) diff += 24;
    durationField.value = decimalToTime(diff);
  }

  if (source === 'duration' && durationField.value) {
    const duration = timeToDecimal(durationField.value);
    const endDecimal = (start + duration) % 24;
    document.getElementById('editEnd').value = decimalToTime(endDecimal);
  }
}



const originalOpenEditModal = openEditModal;
openEditModal = function(index) {
  originalOpenEditModal(index);
  const e = data[index];
  document.getElementById('editDuration').value = decimalToTime(e.duration);
};

const originalSaveEdit = saveEdit;
saveEdit = function() {
  const durationInput = document.getElementById('editDuration').value;
  if (durationInput) {
    const duration = timeToDecimal(durationInput);
    if (duration > 0) {
      const start = document.getElementById('editStart').value;
      const date = document.getElementById('editDate').value;
      const endDecimal = (timeToDecimal(start) + duration) % 24;
      document.getElementById('editEnd').value = decimalToTime(endDecimal);
    }
  }
  originalSaveEdit();
};

function toggleLoginModal() {
  const modal = document.getElementById('loginModal');
  const loginForm = document.getElementById('loginForm');
  const loggedInInfo = document.getElementById('loggedInInfo');
  const userEmail = document.getElementById('userEmail');

  if (modal.style.display === 'block') {
    modal.style.display = 'none';

    // üßº Entferne Click-Outside-Listener hier!
    if (outsideClickHandlers['loginModal']) {
      document.removeEventListener('click', outsideClickHandlers['loginModal']);
      outsideClickHandlers['loginModal'] = null;
    }

    return;
  }

  modal.style.display = 'block';

  if (auth.currentUser) {
    loginForm.style.display = 'none';
    loggedInInfo.style.display = 'block';
    userEmail.innerHTML = `Eingeloggt als:<br><br><strong>${auth.currentUser.email}</strong>`;
  } else {
    loginForm.style.display = 'block';
    loggedInInfo.style.display = 'none';
    userEmail.textContent = '';
  }

  // ‚úÖ Nur beim √ñffnen registrieren
  setupClickOutsideClose('loginModal', '#loginContent', toggleLoginModal);
}


function togglePasswordVisibility() {
  const passwordInput = document.getElementById("password");
  const toggleBtn = document.getElementById("togglePasswordBtn");

  if (passwordInput.type === "password") {
    passwordInput.type = "text";
    toggleBtn.textContent = "Hide";
  } else {
    passwordInput.type = "password";
    toggleBtn.textContent = "Show";
  }
}


/*Kategorien Funktionen*/

document.getElementById('openCategoryModal').addEventListener('click', () => {
  document.getElementById('categorySearch').value = '';
  renderCategoryList();
  document.getElementById('categoryModal').style.display = 'flex';
  setupClickOutsideClose('categoryModal', '#categoryModal > div', closeCategoryModal);
});




function closeCategoryModal() {
  document.getElementById('categoryModal').style.display = 'none';
  if (outsideClickHandlers['categoryModal']) {
    document.removeEventListener('click', outsideClickHandlers['categoryModal']);
    outsideClickHandlers['categoryModal'] = null;
  }
}


function openNewCategoryModal() {
  if (!auth.currentUser) {
    showMessage("Nicht eingeloggt ‚Äì Kategorie wird nicht gespeichert.", "warning");
    return;
  }

  document.getElementById('newCategoryModal').style.display = 'flex';
  setupClickOutsideClose('newCategoryModal', '#newCategoryModal > div', closeNewCategoryModal);
}




function closeNewCategoryModal() {
  document.getElementById('newCategoryModal').style.display = 'none';
  document.getElementById('newCategoryName').value = '';
  document.getElementById('newCategoryHex').value = '#888888';
  document.getElementById('newCategoryColor').value = '#888888';

  if (outsideClickHandlers['newCategoryModal']) {
    document.removeEventListener('click', outsideClickHandlers['newCategoryModal']);
    outsideClickHandlers['newCategoryModal'] = null;
  }

  justClosedModal = true;
  setTimeout(() => { justClosedModal = false; }, 50);
}





function syncColorInputsFromPicker() {
  const picker = document.getElementById('newCategoryColor');
  const hex = document.getElementById('newCategoryHex');
  hex.value = picker.value;
}

function syncColorInputsFromHex() {
  const picker = document.getElementById('newCategoryColor');
  const hex = document.getElementById('newCategoryHex');

  let val = hex.value.trim();
  if (!val.startsWith('#')) val = '#' + val;
  if (/^#[0-9A-Fa-f]{6}$/.test(val)) {
    picker.value = val;
    hex.value = val;
  }
}

document.getElementById('newCategoryColor').addEventListener('input', syncColorInputsFromPicker);
document.getElementById('newCategoryHex').addEventListener('input', syncColorInputsFromHex);


function renderCategoryList(search = '') {
  const list = document.getElementById('categoryList');
  list.innerHTML = '';

  const categories = window.categories || {};

  for (const [name, color] of Object.entries(categories)) {
    if (search && !name.toLowerCase().startsWith(search)) continue;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="color: ${color}; font-weight: 500;">${name}</td>
      <td><code>${color}</code></td>
      <td class="entry-actions">
        <button class="entry-btn" onclick="editCategory('${name}')">‚úèÔ∏è</button>
        <button class="entry-btn" onclick="window.deleteCategory('${name}')">üóëÔ∏è</button>
      </td>
    `;
    list.appendChild(tr);
  }
}

document.getElementById('categorySearch').addEventListener('input', function (e) {
  const searchValue = e.target.value.toLowerCase();
  renderCategoryList(searchValue);
});



function addCategoryFromModal() {
  if (!auth.currentUser) {
        showMessage("Nicht eingeloggt ‚Äì Kategorie wird nicht gespeichert.", "warning");
        return; // ‚õî Bricht die gesamte Funktion ab
      }
  const name = document.getElementById('newCategoryName').value.trim();
  const color = document.getElementById('newCategoryColor').value;

  if (!name || !color) return showMessage("Name und Farbe angeben", "warning");
  if (window.categories[name]) return showMessage("Kategorie existiert bereits", "error");

  window.addCategory(name, color);
  closeNewCategoryModal();
  renderCategoryList();
}

let currentCategoryEditing = null;

function editCategory(oldName) {
  if (!auth.currentUser) {
    showMessage("Nicht eingeloggt ‚Äì Kann nicht bearbeitet werden.", "warning");
    return;
  }
  const color = window.categories[oldName];
  currentCategoryEditing = oldName;

  document.getElementById('editCategoryName').value = oldName;
  document.getElementById('editCategoryColor').value = color;
  document.getElementById('editCategoryHex').value = color;

  document.getElementById('editCategoryModal').style.display = 'flex';
  setupClickOutsideClose('editCategoryModal', '#editCategoryModal > div', closeEditCategoryModal);
}

let justClosedModal = false;

function closeEditCategoryModal() {
  currentCategoryEditing = null;
  document.getElementById('editCategoryModal').style.display = 'none';

  if (outsideClickHandlers['editCategoryModal']) {
    document.removeEventListener('click', outsideClickHandlers['editCategoryModal']);
    outsideClickHandlers['editCategoryModal'] = null;
  }

  // Schutz gegen false-positive Outside-Klicks
  justClosedModal = true;
  setTimeout(() => { justClosedModal = false; }, 50);
}




function saveEditedCategory() {
  const newName = document.getElementById('editCategoryName').value.trim();
  const newColor = document.getElementById('editCategoryColor').value;

  if (!currentCategoryEditing || !newName || !newColor) return;

  if (newName !== currentCategoryEditing && window.categories[newName]) {
    showMessage("Kategorie mit diesem Namen existiert bereits.", "error");
    return;
  }

  // Eintr√§ge aktualisieren, falls Name ge√§ndert wurde
  window.data = window.data.map(e =>
    e.category === currentCategoryEditing
      ? { ...e, category: newName }
      : e
  );

  // Kategorie aktualisieren
  delete window.categories[currentCategoryEditing];
  window.categories[newName] = newColor;

  if (auth.currentUser) {
    saveEntries(auth.currentUser.uid);
    saveCategories(auth.currentUser.uid)
  }

  currentCategoryEditing = null;
  renderCategoryList();
  populateAllCategorySelects();
  updateEntries();
  renderOverview();
  closeEditCategoryModal();
  showMessage("Kategorie aktualisiert.", "success");
}

// Farbfelder synchronisieren (wiederverwendbar!)
document.getElementById('editCategoryColor').addEventListener('input', () => {
  document.getElementById('editCategoryHex').value = document.getElementById('editCategoryColor').value;
});

document.getElementById('editCategoryHex').addEventListener('input', () => {
  const hex = document.getElementById('editCategoryHex');
  let val = hex.value.trim();
  if (!val.startsWith('#')) val = '#' + val;
  if (/^#[0-9A-Fa-f]{6}$/.test(val)) {
    document.getElementById('editCategoryColor').value = val;
    hex.value = val;
  }
});

let editModalOutsideClickHandler = null;


const outsideClickHandlers = {}; // speichert Handler pro Modal

function isVisible(id) {
  const el = document.getElementById(id);
  return el && el.style.display !== 'none';
}

function setupClickOutsideClose(modalId, contentSelector, closeFunction) {
  setTimeout(() => {
    const handler = function(event) {
      if (justClosedModal) return;
      const modal = document.getElementById(modalId);
      const content = document.querySelector(contentSelector);

      // ‚ûï Sonderfall nur f√ºr categoryModal
      if (modalId === 'categoryModal') {
        if (
          modal &&
          modal.style.display !== 'none' &&
          !content.contains(event.target) &&
          !isVisible('editCategoryModal') &&
          !isVisible('newCategoryModal') &&
          !isVisible('confirmModal') // ‚¨ÖÔ∏è neuer Check!
        ) {
          closeFunction();
          document.removeEventListener('click', outsideClickHandlers[modalId]);
          outsideClickHandlers[modalId] = null;
        }
      }
       else {
        // Normalfall: alle anderen Modale (new/edit) schlie√üen sich wie gewohnt
        if (
          modal &&
          modal.style.display !== 'none' &&
          !content.contains(event.target)
        ) {
          closeFunction();
          document.removeEventListener('click', outsideClickHandlers[modalId]);
          outsideClickHandlers[modalId] = null;
        }
      }
    };

    if (outsideClickHandlers[modalId]) {
      document.removeEventListener('click', outsideClickHandlers[modalId]);
    }

    outsideClickHandlers[modalId] = handler;
    document.addEventListener('click', handler);
  }, 10);
}





</script>
<!-- Stoppuhr -->
<div class="section" id="stopwatch">
<h2>Stoppuhr</h2>
<form id="stopwatchForm">
<div id="stopwatchDisplay">00:00:00</div>

<label for="stopwatchCategoryInput">Kategorie:</label>
<div class="category-dropdown">
  <div id="stopwatchCategorySelected" class="selected-option" onclick="toggleStopwatchDropdown()">Kategorie w√§hlen</div>
  <div id="stopwatchDropdownContent" class="dropdown-content">
    <input type="text" id="stopwatchSearchInput" placeholder="Kategorie suchen..." class="category-search">
    <ul id="stopwatchOptions" class="options-list"></ul>
  </div>
</div>


<!--
<label for="stopwatchCategory">Kategorie:</label>
<select id="stopwatchCategory"></select>
-->


<label for="stopwatchDescription">Beschreibung:</label>
<textarea id="stopwatchDescription" placeholder="Mehrzeiliger Text, Abs√§tze m√∂glich..." rows="4"></textarea>
<button id="stopwatchButton" onclick="toggleStopwatch()" type="button">Start</button>
</form>
</div>
<!-- √úbersicht -->
<div class="section" id="overview">
<h2>√úbersicht</h2>
<div class="inline-group" id="overviewTabs" style="margin-bottom: 1em;">
<button id="btn-filter-day" onclick="setOverviewFilter('day')">Tag</button>
<button class="active-overview" id="btn-filter-week" onclick="setOverviewFilter('week')">Woche</button>
<button id="btn-filter-month" onclick="setOverviewFilter('month')">Monat</button>
<button id="btn-filter-year" onclick="setOverviewFilter('year')">Jahr</button>
</div>

<div class="category-dropdown" style="max-width: 300px; margin: 0 auto 1em;">
  <div id="overviewCategorySelected" class="selected-option" onclick="toggleOverviewCategoryDropdown()">Kategorie w√§hlen</div>
  <div id="overviewDropdownContent" class="dropdown-content">
    <input type="text" id="overviewSearchInput" placeholder="Kategorie suchen..." class="category-search">
    <ul id="overviewCategoryOptions" class="options-list"></ul>
  </div>
</div>

<div id="weekNav" style="text-align: center; margin-bottom: 1em; display: none;"></div>
<div id="overviewDateWrapper" style="margin-bottom: 1em;">
<input id="overviewDate" onchange="renderOverview()" type="date"/>
</div>
<div id="overviewSummaryTable" style="margin-bottom: 2em;"></div>
<canvas id="overviewChart"></canvas>
<div id="overviewTimelineTable" style="margin-bottom: 2em;"></div>
</div>
<!-- Eintr√§ge -->
<div class="section" id="entries">
<h2>Eintr√§ge</h2>
<div class="entry-filters-row" style="display: flex; flex-wrap: wrap; gap: 1em; align-items: flex-end; margin-bottom: 1.5em;">
  <div style="flex: 1; min-width: 140px; max-width: 200px;">
    <label for="entryDateFilterType">Zeitraum filtern:</label>
    <select id="entryDateFilterType" onchange="updateEntryDateInput()" style="width: 100%;">
      <option value="none">Alle</option>
      <option value="day">Tag</option>
      <option value="week">Woche</option>
      <option value="month">Monat</option>
      <option value="year">Jahr</option>
    </select>
  </div>

  <div id="entryDateInputContainer" style="flex: 1; min-width: 140px; max-width: 200px;">
    <!-- hier kommt der Jahr/Monat/Woche Input rein -->
  </div>

  <div style="flex: 1; min-width: 160px; max-width: 240px;">
    <label for="entryCategorySelected">Kategorie filtern:</label>
    <div class="category-dropdown" style="width: 100%;">
      <div id="entryCategorySelected" class="selected-option" onclick="toggleEntryCategoryDropdown()">Alle</div>
      <div id="entryDropdownContent" class="dropdown-content">
        <input type="text" id="entrySearchInput" placeholder="Kategorie suchen..." class="category-search">
        <ul id="entryCategoryOptions" class="options-list"></ul>
      </div>
    </div>
  </div>
  
</div>


<div id="entriesList"></div>
<div id="paginationControls" style="text-align: center; margin-top: 1.2em;"></div>
</div>
<!-- Modal f√ºr Bearbeiten -->
<div id="editModal">
<h3>Eintrag bearbeiten</h3>
<div class="modal-two-cols">
<!-- Linke Spalte -->
<div class="modal-left">
<label for="editDate">Datum:</label>
<input id="editDate" type="date"/>
<div class="inline-group">
  <div class="field-third">
    <label for="editStart">Startzeit:</label>
    <input type="time" id="editStart" />
  </div>
  <div class="field-third">
    <label for="editEnd">Endzeit:</label>
    <input type="time" id="editEnd" />
  </div>
  <div class="field-third">
    <label for="editDuration">Dauer:</label>
    <input type="text" id="editDuration" placeholder="--:--" />
  </div>
</div>

<label for="editCategoryInput">Kategorie:</label>
<div class="category-dropdown">
  <div id="editCategorySelected" class="selected-option" onclick="toggleEditDropdown()">Kategorie w√§hlen</div>
  <div id="editDropdownContent" class="dropdown-content">
    <input type="text" id="editSearchInput" placeholder="Kategorie suchen..." class="category-search">
    <ul id="editCategoryOptions" class="options-list"></ul>
  </div>
</div>

<!-- geht sicher
<label for="editCategory">Kategorie:</label>
<select id="editCategory"></select>
-->

</div>
<!-- Rechte Spalte -->
<div class="modal-right">
<label for="editDescription">Beschreibung:</label>
<textarea id="editDescription" placeholder="Optional..."></textarea>
</div>
</div>
<div class="modal-buttons">
<button onclick="saveEdit()">Speichern</button>
<button onclick="closeEditModal()">Abbrechen</button>
</div>
</div>


<!--Firebase-->
<script type="module">


window.populateAllCategorySelects = function () {
  const dropdownIds = ['categoryInput', 'stopwatchCategory', 'editCategory'];

  dropdownIds.forEach(id => {
    const select = document.getElementById(id);
    if (!select) return;

    // Aktuellen Wert merken
    const currentValue = select.value;

    // Alles leeren
    select.innerHTML = '';

    // Platzhalteroption
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = 'Kategorie w√§hlen';
    select.appendChild(defaultOption);

    // üî• WICHTIG: window.categories verwenden!
    for (const [name, color] of Object.entries(window.categories || {})) {
      const option = document.createElement('option');
      option.value = name;
      option.textContent = name;
      option.style.color = color;
      select.appendChild(option);
    }

    // Versuch, vorherige Auswahl wiederherzustellen
    if (currentValue && [...select.options].some(opt => opt.value === currentValue)) {
      select.value = currentValue;
    }
  });
}



  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAiD9eEoZtjUyFJjy2olJRozHKJqkmHaZg",
    authDomain: "timetracker-5ddd9.firebaseapp.com",
    projectId: "timetracker-5ddd9",
    storageBucket: "timetracker-5ddd9.firebasestorage.app",
    messagingSenderId: "274377553389",
    appId: "1:274377553389:web:01cf4e8394795756c1a3e4",
    measurementId: "G-L8KL2N9CGY"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  window.auth = auth
  const db = getFirestore(app);


  window.login = function () {
  const email = document.getElementById('email').value.trim();
  const pass = document.getElementById('password').value;

  if (!email || !pass) {
    showMessage("Bitte gib E-Mail und Passwort ein.", "info");
    return;
  }

  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    showMessage("Ung√ºltiges E-Mail-Format!", "error");
    return;
  }

  signInWithEmailAndPassword(auth, email, pass)
    .then(() => {
      showMessage("Login erfolgreich!<br><br><strong>Willkommen!</strong>", "success");

      // üßº Close login modal + remove listener
      document.getElementById('loginModal').style.display = 'none';

      if (outsideClickHandlers['loginModal']) {
        document.removeEventListener('click', outsideClickHandlers['loginModal']);
        outsideClickHandlers['loginModal'] = null;
      }
    })
    .catch(e => {
      showMessage("Fehler beim Login: " + e.message, "error");
      console.error("Login-Fehler:", e);
    });
};




  

window.logout = function () {
  signOut(auth)
    .then(() => {
      showMessage("Logout erfolgreich!", "success");

      document.getElementById('loginModal').style.display = 'none';

      if (outsideClickHandlers['loginModal']) {
        document.removeEventListener('click', outsideClickHandlers['loginModal']);
        outsideClickHandlers['loginModal'] = null;
      }
    })
    .catch(e => {
      showMessage("Fehler beim Logout: " + e.message, "error");
    });
};


  /* onAuthStateChanged(auth, user => {
    if (user) {
      document.getElementById('logoutBtn').style.display = 'block';
      document.getElementById('loginModal').style.display = 'none';
      loadEntries(user.uid);
      showMessage("Login erfolgreich!");
    } else {
      document.getElementById('logoutBtn').style.display = 'none';
      document.getElementById('loginModal').style.display = 'none';
      data = [];
      updateEntries();
      showMessage("Du bist ausgeloggt.");
    }
  });
*/
onAuthStateChanged(auth, user => {
  const btn = document.getElementById('authButton');
  const modal = document.getElementById('loginModal');

  if (user) {
    btn.textContent = "Status: Eingeloggt";
    modal.style.display = 'none'; // ‚Üê MODAL SCHLIESSEN BEIM LOGIN
    loadEntries(user.uid);
  } else {
    showMessage("Du bist ausgeloggt.", "warning");
    btn.textContent = "Status: Nicht eingeloggt";
    modal.style.display = 'none'; // ‚Üê MODAL SCHLIESSEN BEIM LOGOUT
    window.data = [];
    updateEntries();
    renderOverview();
  }
});

window.addEventListener('click', function (event) {
  const modal = document.getElementById('loginModal');
  const content = document.getElementById('loginContent');
  const authButton = document.getElementById('authButton');

  if (
    modal.style.display === 'flex' &&
    !content.contains(event.target) &&
    !authButton.contains(event.target)
  ) {
    modal.style.display = 'none';
  }
});





async function loadEntries(uid) {
  const docRef = doc(db, "users", uid);
  const docSnap = await getDoc(docRef);

  const docData = docSnap.exists() ? docSnap.data() : {};
  window.data = docData.entries || [];

  // Falls Kategorien fehlen oder leer sind ‚Üí Standard setzen
  if (!docData.categories || Object.keys(docData.categories).length === 0) {
    console.log("üì¶ Keine Kategorien vorhanden ‚Äì setze Defaults");

    window.categories = {
      "Fluid Dynamics": "#1F77B4",
      "SML": "#D62728",
      "Quantum Mechanics": "#9467BD",
      "WuF": "#2CA02C",
      "Thermo II": "#FF7F0E",
      "Thermo III": "#8C564B"
    };

    await saveCategories(uid); // deine bestehende save-Funktion
    showMessage("Standardkategorien wurden gesetzt", "info");
  } else {
    window.categories = docData.categories;
  }

  populateAllCategorySelects();
  renderFilteredCategories('');
  updateEntries();
  renderOverview();
  updateCategoryOptions();
}





window.saveEntries = async function(uid) {
  console.log("üî• Speichere nur entries f√ºr UID:", uid);
  try {
    await setDoc(doc(db, "users", uid), {
      entries: window.data || []
    }, { merge: true });
    console.log("‚úÖ Entries gespeichert");
  } catch (err) {
    console.error("‚ùå Fehler beim Speichern der Eintr√§ge:", err);
    showMessage("Fehler beim Speichern der Eintr√§ge!", "error");
  }
};




/*Kategorien*/
window.saveCategories = async function(uid) {
  try {
    const ref = doc(db, "users", uid);

    // üîç Bestehende Daten holen
    const snap = await getDoc(ref);
    const data = snap.exists() ? snap.data() : {};

    // üß† Neue Daten zusammenbauen
    const newData = {
      ...data,
      categories: window.categories || {}
    };

    // üíæ Alles speichern (komplett, aber nichts verlieren)
    await setDoc(ref, newData, { merge: false });

    // ‚úÖ Sicherstellen, dass lokal alles da ist
    window.categories = newData.categories;

    console.log("‚úÖ Kategorien gespeichert");
    showMessage("Kategorien gespeichert", "success");
  } catch (err) {
    console.error("‚ùå Fehler beim Speichern der Kategorien:", err);
    showMessage("Fehler beim Speichern der Kategorien!", "error");
  }
};


/*
window.loadCategories = async function(uid) {
  try {

    if (!window.categories || Object.keys(window.categories).length === 0) {
  console.log("Kategorien sind leer üö´");
} else {
  console.log("Kategorien vorhanden ‚úÖ", window.categories);
}


    const ref = doc(db, "users", uid);
    const snap = await getDoc(ref);
    const data = snap.exists() ? snap.data() : {};

    
    window.categories = data.categories || {};
    populateAllCategorySelects();
    console.log("‚úÖ Kategorien geladen:", window.categories);
  } catch (err) {
    console.error("‚ùå Fehler beim Laden der Kategorien:", err);
    showMessage("Fehler beim Laden der Kategorien!", "error");
  }
};
*/

window.addCategory = function(name, color) {
  if (!name || window.categories[name]) {
    showMessage("Ung√ºltiger Name oder Kategorie existiert schon", "warning");
    return;
  }

  window.categories[name] = color;
  if (auth.currentUser) {
    window.saveCategories(auth.currentUser.uid);
  }
  populateAllCategorySelects();
};

window.deleteCategory = function(name) {
  if (!auth.currentUser) {
        showMessage("Nicht eingeloggt ‚Äì Kann nicht gel√∂scht werden.", "warning");
        return; // ‚õî Bricht die gesamte Funktion ab
      }
  customConfirm(`Kategorie "${name}" wirklich l√∂schen?`, () => {
    // ‚úÖ Kategorie aus categories entfernen
    delete window.categories[name];

    // ‚úÖ Eintr√§ge, die diese Kategorie haben, neutralisieren
    if (Array.isArray(window.data)) {
  window.data = window.data.map(e =>
    e.category === name ? { ...e, category: '' } : e
  );
} else {
  console.warn("‚ö†Ô∏è Daten nicht geladen oder leer ‚Äì keine Eintr√§ge aktualisiert.");
}


    // ‚úÖ Speichern
    if (auth.currentUser) {
  saveEntries(auth.currentUser.uid);     // entries speichern
  saveCategories(auth.currentUser.uid);  // üî• auch categories neu speichern!
}


    // ‚úÖ UI aktualisieren
    populateAllCategorySelects?.(); // nur wenn vorhanden
    updateEntries?.();
    renderOverview?.();
    renderCategoryList?.();

    showMessage("Kategorie gel√∂scht", "success");
  });
};


/*
window.updateCategory = function(oldName, newName, newColor) {
  const trimmedOld = oldName.trim();
  const trimmedNew = newName.trim();

  if (!window.categories[trimmedOld]) return;

  if (trimmedOld !== trimmedNew) {
    // üîÑ Eintr√§ge √§ndern
    window.data = window.data.map(e =>
      e.category === trimmedOld ? { ...e, category: trimmedNew, color: newColor } : e
    );

    // ‚úÇÔ∏è Alte Kategorie l√∂schen, neue setzen
    delete window.categories[trimmedOld];
    window.categories[trimmedNew] = newColor;
  } else {
    // üé® Nur Farbe √§ndern
    window.categories[trimmedOld] = newColor;

    // üîÑ Farbe auch in Eintr√§gen aktualisieren
    window.data = window.data.map(e =>
      e.category === trimmedOld ? { ...e, color: newColor } : e
    );
  }

  // üíæ Speichern
  if (auth.currentUser) {
    window.saveEntries(auth.currentUser.uid);
    window.saveCategories(auth.currentUser.uid);
  }

  // üîÉ UI updaten
  updateEntries?.();
  renderOverview?.();
  renderCategoryList?.();
  showMessage("Kategorie aktualisiert", "success");
};

*/




window.toggleCategoryDropdown = function () {
  const dropdown = document.getElementById('categoryDropdownContent');
  dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
  document.getElementById('categorySearchInput').value = '';
  window.renderFilteredCategories('');
};

const dropdownPairs = [
  { buttonId: 'categorySelected', dropdownId: 'categoryDropdownContent' },
  { buttonId: 'stopwatchCategorySelected', dropdownId: 'stopwatchDropdownContent' },
  { buttonId: 'editCategorySelected', dropdownId: 'editDropdownContent' },
  { buttonId: 'overviewCategorySelected', dropdownId: 'overviewDropdownContent' },
  { buttonId: 'entryCategorySelected', dropdownId: 'entryDropdownContent' }
];


document.addEventListener('click', function(event) {
  dropdownPairs.forEach(({ buttonId, dropdownId }) => {
    const button = document.getElementById(buttonId);
    const dropdown = document.getElementById(dropdownId);

    if (
      dropdown &&
      dropdown.style.display === 'block' &&
      !dropdown.contains(event.target) &&
      !button.contains(event.target)
    ) {
      dropdown.style.display = 'none';
    }
  });
});



window.renderFilteredCategories = function (filter) {
  const list = document.getElementById('categoryOptions');
  list.innerHTML = '';

  for (const [name, color] of Object.entries(window.categories || {})) {
    if (!name.toLowerCase().startsWith(filter.toLowerCase())) continue;


    const li = document.createElement('li');
    li.textContent = name;
    li.style.color = color;

    li.onclick = () => {
      const label = document.getElementById('categorySelected');
label.textContent = name;
label.style.color = color;
      document.getElementById('categoryDropdownContent').style.display = 'none';
      window.selectedCategory = name;
    };

    list.appendChild(li);
  }
};

document.getElementById('categorySearchInput').addEventListener('input', (e) => {
  const value = e.target.value.trim();
  window.renderFilteredCategories(value);
});

window.toggleStopwatchDropdown = function () {
  const dropdown = document.getElementById('stopwatchDropdownContent');
  dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
  document.getElementById('stopwatchSearchInput').value = '';
  window.renderFilteredCategoriesStopwatch('');
};

window.renderFilteredCategoriesStopwatch = function (filter) {
  const list = document.getElementById('stopwatchOptions');
  list.innerHTML = '';

  for (const [name, color] of Object.entries(window.categories || {})) {
    if (!name.toLowerCase().startsWith(filter.toLowerCase())) continue;

    const li = document.createElement('li');
    li.textContent = name;
    li.style.color = color;

    li.onclick = () => {
      const label = document.getElementById('stopwatchCategorySelected');
label.textContent = name;
label.style.color = color;
      document.getElementById('stopwatchDropdownContent').style.display = 'none';
      window.selectedStopwatchCategory = name;
    };

    list.appendChild(li);
  }
};

document.getElementById('stopwatchSearchInput').addEventListener('input', (e) => {
  const value = e.target.value.trim();
  window.renderFilteredCategoriesStopwatch(value);
});


window.toggleEditDropdown = function () {
  const dropdown = document.getElementById('editDropdownContent');
  dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
  document.getElementById('editSearchInput').value = '';
  window.renderFilteredCategoriesEdit('');
};

window.renderFilteredCategoriesEdit = function (filter) {
  const list = document.getElementById('editCategoryOptions');
  list.innerHTML = '';

  for (const [name, color] of Object.entries(window.categories || {})) {
    if (!name.toLowerCase().startsWith(filter.toLowerCase())) continue;

    const li = document.createElement('li');
    li.textContent = name;
    li.style.color = color;

    li.onclick = () => {
  const label = document.getElementById('editCategorySelected'); // ‚úÖ Element holen UND speichern!
  label.textContent = name;
  label.style.color = color;

  document.getElementById('editDropdownContent').style.display = 'none';
  window.selectedEditCategory = name;
};

    list.appendChild(li);
  }
};

document.getElementById('editSearchInput').addEventListener('input', (e) => {
  const value = e.target.value.trim();
  window.renderFilteredCategoriesEdit(value);
});


window.toggleOverviewCategoryDropdown = function () {
  const dropdown = document.getElementById('overviewDropdownContent');
  dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
  document.getElementById('overviewSearchInput').value = '';
  window.renderFilteredOverviewCategories('');
};

window.renderFilteredOverviewCategories = function (filter) {
  const list = document.getElementById('overviewCategoryOptions');
  list.innerHTML = '';

  // üÜï Zuerst "Alle"-Option einf√ºgen
  const alleOption = document.createElement('li');
  alleOption.textContent = 'Alle';
  alleOption.style.color = '#000';
  alleOption.onclick = () => {
    const label = document.getElementById('overviewCategorySelected');
    label.textContent = 'Alle';
    label.style.color = '#000';
    window.currentOverviewCategory = 'Alle';
    document.getElementById('overviewDropdownContent').style.display = 'none';
    renderOverview();
  };
  list.appendChild(alleOption);

  // üß† Dann alle Kategorien einf√ºgen
  for (const [name, color] of Object.entries(window.categories || {})) {
    if (!name.toLowerCase().startsWith(filter.toLowerCase())) continue;

    const li = document.createElement('li');
    li.textContent = name;
    li.style.color = color;

    li.onclick = () => {
      const label = document.getElementById('overviewCategorySelected');
      label.textContent = name;
      label.style.color = color;

      document.getElementById('overviewDropdownContent').style.display = 'none';
      window.currentOverviewCategory = name;
      renderOverview();
    };
    document.getElementById('overviewSearchInput').addEventListener('input', (e) => {
  const value = e.target.value.trim();
  window.renderFilteredOverviewCategories(value);
});


    list.appendChild(li);
  }
  
};


window.toggleEntryCategoryDropdown = function () {
  const dropdown = document.getElementById('entryDropdownContent');
  dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
  document.getElementById('entrySearchInput').value = '';
  window.renderFilteredCategoriesEntry('');
};

window.renderFilteredCategoriesEntry = function (filter) {
  const list = document.getElementById('entryCategoryOptions');
  list.innerHTML = '';

  // "Alle"-Option
  const alleOption = document.createElement('li');
  alleOption.textContent = 'Alle';
  alleOption.style.color = '#000';
  alleOption.onclick = () => {
    const label = document.getElementById('entryCategorySelected');
    label.textContent = 'Alle';
    label.style.color = '#000';
    window.currentEntryCategory = 'Alle';
    document.getElementById('entryDropdownContent').style.display = 'none';
    updateEntries();
  };
  list.appendChild(alleOption);

  for (const [name, color] of Object.entries(window.categories || {})) {
    if (!name.toLowerCase().startsWith(filter.toLowerCase())) continue;

    const li = document.createElement('li');
    li.textContent = name;
    li.style.color = color;

    li.onclick = () => {
      const label = document.getElementById('entryCategorySelected');
      label.textContent = name;
      label.style.color = color;
      window.currentEntryCategory = name;

      document.getElementById('entryDropdownContent').style.display = 'none';
      updateEntries();
    };

    list.appendChild(li);
  }
};

document.getElementById('entrySearchInput').addEventListener('input', (e) => {
  const value = e.target.value.trim();
  window.renderFilteredCategoriesEntry(value);
});


</script>
<!--Confirm-->
<div id="confirmModal" style="
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.4);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
">
  <div style="
    background: white;
    padding: 2em;
    border-radius: 12px;
    max-width: 360px;
    width: 90%;
    text-align: center;
    box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    font-size: 1.05em;
  ">
    <p id="confirmText" style="margin-bottom: 1.5em;">Bist du sicher?</p>
    <div style="display: flex; justify-content: center; gap: 1em;">
      
      <button id="confirmOK" style="
        padding: 0.5em 1.2em;
        background: #f44336;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      ">L√∂schen</button>

    <button id="confirmCancel" style="
      padding: 0.6em 1.2em;
      font-size: 1em;
      border-radius: 6px;
      border: none;
      background: #3976e8;
      color: white;
      cursor: pointer;
      transition: background 0.2s ease;
    ">Abbrechen</button>


    </div>
  </div>
</div>
<footer class="footer">
  <p>&copy; Johannes Schulte-Vels <br>
    <strong>Mail me for an Account:</strong> <br>
    <a href="mailto:j.schultevels@gmail.com">j.schultevels@gmail.com</a>
  </p>
</footer>
</body></html>